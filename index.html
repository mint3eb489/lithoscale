<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LithoScale PRO | Team Sync</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        trueBlack: '#000000',
                        darkCard: '#121212',
                        darkBorder: '#262626',
                        gold: { DEFAULT: '#fbbf24' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { transition: background-color 0.2s; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .input-field { border: 1.5px solid #e2e8f0; border-radius: 0.75rem; padding: 0.8rem; width: 100%; outline: none; font-weight: 600; font-size: 16px; transition: all 0.2s; }
        .dark .input-field { background-color: #1a1a1a; border-color: #333; color: white; }
        .input-field:focus { border-color: #3b82f6; }
        .card { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; }
        .dark .card { background: #121212; border-color: #262626; }
        .pro-badge { display: inline-flex; align-items: center; border: 1.2px solid #fbbf24; color: #fbbf24; border-radius: 5px; padding: 2px 6px; font-size: 0.45em; font-weight: 900; margin-left: 10px; vertical-align: middle; transform: translateY(-2px); }
        .tab-btn { padding: 0.8rem 1rem; font-weight: 700; font-size: 0.85rem; border-radius: 0.8rem; flex: 1; text-align: center; transition: all 0.2s; }
        .active-tab { background: #1a1a1a; color: white; }
        .dark .active-tab { background: #ffffff; color: #000000; }
        
        .badge-dekton { background: #ef4444; color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .badge-natur { background: #10b981; color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; }

        .modal-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="p-3 md:p-8 bg-slate-50 dark:bg-trueBlack text-slate-900 dark:text-slate-100">

    <div id="app" class="max-w-4xl mx-auto">
        <!-- Cloud Sync Status Bar -->
        <div id="cloud-status" class="fixed top-4 right-4 text-[9px] font-bold uppercase tracking-widest z-50 flex flex-col items-end gap-1">
            <div class="flex items-center gap-2 bg-white/90 dark:bg-black/80 p-2 px-3 rounded-full shadow-lg border dark:border-darkBorder">
                <span id="status-text" class="text-slate-400">Verbindung prüfen...</span>
                <div id="status-icon" class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"></div>
            </div>
            <div id="error-display" class="hidden text-[8px] text-red-500 bg-red-500/10 p-2 px-3 rounded-lg border border-red-500/20 max-w-[250px] text-right"></div>
            <button id="manual-init-btn" onclick="resetAndPush()" class="hidden text-[8px] bg-blue-600 text-white p-2 px-3 rounded-xl mt-1 uppercase font-black shadow-lg">Katalog-Reset (Alle Steine laden)</button>
        </div>

        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-black dark:bg-white rounded-2xl flex items-center justify-center shadow-2xl border border-white/10">
                    <svg class="w-9 h-9 text-blue-500 dark:text-black" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M3 3h18v18H3zM3 9h18M9 3v18" stroke-linecap="round"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black flex items-center tracking-tighter select-none">
                        LithoScale <span class="pro-badge">PRO</span>
                    </h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-slate-400">Team Cloud Sync</p>
                </div>
            </div>
            <div class="flex items-center gap-4 w-full md:w-auto">
                <button onclick="toggleTheme()" class="p-4 bg-white dark:bg-darkCard rounded-2xl border dark:border-darkBorder shadow-sm">
                    <svg id="sunIcon" class="w-5 h-5 text-amber-500 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                    <svg id="moonIcon" class="w-5 h-5 text-slate-700" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                <div class="flex bg-white dark:bg-darkCard p-1 rounded-2xl border dark:border-darkBorder shadow-sm flex-1">
                    <button onclick="switchTab('calc')" id="btn-calc" class="tab-btn active-tab uppercase tracking-widest text-[10px]">Rechner</button>
                    <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn inactive-tab uppercase tracking-widest text-[10px]">Admin</button>
                </div>
            </div>
        </header>

        <div id="main-ui">
            <!-- RECHNER -->
            <div id="tab-calc" class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 space-y-5">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-5 border-b dark:border-darkBorder pb-3">
                            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Konfiguration</h2>
                            <div id="materialBadge"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="md:col-span-2">
                                <label class="text-[10px] font-black text-slate-500 uppercase ml-1">Steinart</label>
                                <select id="stoneSelect" class="input-field mt-1" onchange="calculate()"></select>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-500 uppercase ml-1">Fläche (m²)</label>
                                <input type="number" id="sqmInput" placeholder="0,00" step="0.01" class="input-field mt-1 font-mono text-center" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-500 uppercase ml-1">Kante (Lfm)</label>
                                <input type="number" id="lfmInput" placeholder="0,00" step="0.01" class="input-field mt-1 font-mono text-center" oninput="calculate()">
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-5 border-b dark:border-darkBorder pb-3">Bearbeitungen</h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-black rounded-xl border dark:border-darkBorder">
                                <p class="font-bold text-sm">Flächenbündig</p>
                                <div class="flex items-center border dark:border-darkBorder rounded-lg bg-white dark:bg-darkCard overflow-hidden">
                                    <button onclick="updateCounter('flushCount', -1)" class="px-4 py-1 hover:bg-slate-50 font-bold">-</button>
                                    <span id="flushCount" class="w-10 text-center font-black">0</span>
                                    <button onclick="updateCounter('flushCount', 1)" class="px-4 py-1 hover:bg-slate-50 font-bold">+</button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-black rounded-xl border dark:border-darkBorder">
                                <p class="font-bold text-sm">Unterbau</p>
                                <div class="flex items-center border dark:border-darkBorder rounded-lg bg-white dark:bg-darkCard overflow-hidden">
                                    <button onclick="updateCounter('underCount', -1)" class="px-4 py-1 hover:bg-slate-50 font-bold">-</button>
                                    <span id="underCount" class="w-10 text-center font-black">0</span>
                                    <button onclick="updateCounter('underCount', 1)" class="px-4 py-1 hover:bg-slate-50 font-bold">+</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="number" id="miterInput" placeholder="Gehrung (Lfm)" step="0.01" class="input-field font-mono text-center" oninput="calculate()">
                                <label id="gluingLabel" class="flex items-center justify-center p-4 border-2 border-dashed rounded-xl cursor-pointer transition-all border-slate-200 dark:border-darkBorder h-[54px]">
                                    <input type="checkbox" id="gluingCheck" class="hidden" onchange="toggleGlue()">
                                    <span class="text-[10px] font-black uppercase tracking-widest">Verkleben</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="resetCalculator()" class="w-full py-4 text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 hover:text-red-500 transition-colors">Kalkulation zurücksetzen</button>
                </div>

                <div class="lg:col-span-2">
                    <div class="p-6 md:p-8 bg-black text-white rounded-3xl sticky top-8 shadow-2xl border border-darkBorder">
                        <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-6 border-b border-darkBorder pb-4 text-center">Zusammenfassung</h2>
                        <div class="space-y-4 text-xs mb-8">
                            <div class="flex justify-between font-mono"><span class="text-slate-500 uppercase">Material</span><span id="resMat">0,00 €</span></div>
                            <div class="flex justify-between font-mono"><span class="text-slate-500 uppercase">Kanten</span><span id="resEdge">0,00 €</span></div>
                            <div class="flex justify-between font-mono"><span class="text-slate-500 uppercase">Ausschnitte</span><span id="resCut">0,00 €</span></div>
                            <div class="flex justify-between text-blue-500 border-t border-darkBorder pt-4 font-mono"><span class="font-bold uppercase tracking-widest">Service Total</span><span id="resExtra" class="font-bold">0,00 €</span></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-8">
                            <button onclick="toggleService('measure')" id="btn-measure" class="py-3 px-2 border border-darkBorder rounded-xl text-[10px] font-bold text-slate-500 uppercase transition-all">Aufmaß</button>
                            <button onclick="toggleService('delivery')" id="btn-delivery" class="py-3 px-2 border border-darkBorder rounded-xl text-[10px] font-bold text-slate-500 uppercase transition-all">Montage</button>
                        </div>

                        <div class="text-center mb-6 pt-4 border-t border-white/5">
                            <p class="text-[9px] font-black text-slate-600 uppercase mb-1 tracking-widest">Einkaufspreis (EK Netto)</p>
                            <p id="totalEK" class="text-lg font-bold text-slate-400 font-mono tracking-tighter">0,00 €</p>
                        </div>

                        <div class="p-6 bg-white/5 rounded-2xl border border-blue-600/30 text-center shadow-inner">
                            <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2">Verkaufspreis (VK Brutto)</p>
                            <p id="totalVK" class="text-4xl font-black text-blue-500 tracking-tighter">0,00 €</p>
                            <p class="text-[8px] text-slate-500 mt-2 italic">*Kalkuliert mit aktuellem Faktor</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="tab-admin" class="hidden space-y-6 pb-20">
                <div class="card p-6 bg-blue-600/5 border border-blue-500/20 rounded-2xl flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-black text-blue-600">Cloud-Management</h2>
                        <p class="text-xs text-slate-500">Änderungen hier speichern, um sie im Team zu synchronisieren.</p>
                    </div>
                    <button onclick="pushToCloud()" id="btn-push" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-600/20 active:scale-95 transition-all">UPLOAD CLOUD</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] mb-4">Preis-Parameter</h3>
                        <div id="admin-fields" class="space-y-4"></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] mb-4">Material-Katalog</h3>
                        <div class="flex justify-end mb-4">
                            <button onclick="addStone()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest hover:bg-blue-600 transition-all">+ Stein hinzufügen</button>
                        </div>
                        <div id="admin-table" class="space-y-3 overflow-y-auto max-h-[600px] pr-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="admin-gate" class="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm items-center justify-center hidden p-4">
            <div class="card p-8 max-w-sm w-full shadow-2xl modal-fade">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    </div>
                    <h2 class="text-xl font-black tracking-tight">Admin-Zugang</h2>
                    <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">Passwort erforderlich</p>
                </div>
                <input type="password" id="adminPassInput" placeholder="••••" class="input-field text-center text-2xl tracking-widest mb-4" autofocus>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeAdminGate()" class="py-3 rounded-xl font-bold text-xs uppercase tracking-widest bg-slate-100 dark:bg-white/5 text-slate-400">Abbrechen</button>
                    <button onclick="checkAdminPass()" class="py-3 rounded-xl font-bold text-xs uppercase tracking-widest bg-blue-600 text-white shadow-lg shadow-blue-600/20">Login</button>
                </div>
            </div>
        </div>

        <div id="alert-box" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] hidden">
            <div id="alert-content" class="bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl font-bold text-sm border border-white/10 flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-blue-500 animate-ping"></div>
                <span id="alert-text"></span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Hier deine Keys eintragen) ---
        const firebaseConfig = {
    apiKey: "AIzaSyCAoHre4UD7u88JyGvyPYzrfm50OsMOrZ8",
    authDomain: "lithoscalepro.firebaseapp.com",
    projectId: "lithoscalepro",
    storageBucket: "lithoscalepro.firebasestorage.app",
    messagingSenderId: "1090400345045",
    appId: "1:1090400345045:web:fd1cc58fd1e620a9127b5c"
        };

        const internalAppId = 'lithoscale-pro-team-v1';
        
        let app, auth, db;
        let lastLocalUpdate = 0; 
        let isUploading = false;

        const DEFAULTS = {
            stones: [
                { name: "Marinace Black 2cm", price: 325, isDekton: false },
                { name: "Dekton Morpheus", price: 652, isDekton: true },
                { name: "Steel Grey 226", price: 226, isDekton: false },
                { name: "Dekton Laurent", price: 456, isDekton: true },
                { name: "Dekton Kairos", price: 384, isDekton: true },
                { name: "Dekton Domoos", price: 576, isDekton: true },
                { name: "Café Imperial", price: 275, isDekton: false },
                { name: "Breccia Imperiale", price: 395, isDekton: false },
                { name: "Dekton Albarium", price: 576, isDekton: true },
                { name: "Dekton Sandik", price: 576, isDekton: true },
                { name: "Dekton Adia", price: 576, isDekton: true },
                { name: "Dekton Opera", price: 641, isDekton: true },
                { name: "Dekton Reverie", price: 641, isDekton: true },
                { name: "Via Lattea", price: 275, isDekton: false },
                { name: "Dekton Lunar 22", price: 379, isDekton: true },
                { name: "Tropical Storm", price: 395, isDekton: false },
                { name: "Dekton Entzo", price: 641, isDekton: true },
                { name: "Dekton Sirius PROMO", price: 380, isDekton: true },
                { name: "Dekton Eter PROMO", price: 360, isDekton: true },
                { name: "Dekton Danae", price: 384, isDekton: true },
                { name: "Dekton Aeris", price: 384, isDekton: true },
                { name: "Dekton REM PROMO", price: 465, isDekton: true },
                { name: "Mont Blanc 542 poliert", price: 542, isDekton: false },
                { name: "Dekton Sasea PG1", price: 495, isDekton: true },
                { name: "Dekton Nacre PG1", price: 495, isDekton: true },
                { name: "Taj Mahal poliert Südamerika", price: 495, isDekton: false },
                { name: "Dekton Arga Stonika PG4", price: 750, isDekton: true },
                { name: "Nero Assoluto", price: 245, isDekton: false }
            ],
            config: { 
                factor: 1.5, measure: 100, delivery: 700, gluing: 250, 
                natEdge: 15, dekEdge: 20, natCut: 137, dekCut: 177, 
                miter: 45, adminPass: "1234" 
            }
        };

        const configLabels = {
            factor: "VK-Faktor (z.B. 1.5)", measure: "Aufmaß (€)", delivery: "Montage (€)",
            gluing: "Verkleben (€)", natEdge: "Kante Natur (€/Lfm)", dekEdge: "Kante Dekton (€/Lfm)",
            natCut: "Ausschnitt Natur (€/Stk)", dekCut: "Ausschnitt Dekton (€/Stk)",
            miter: "Gehrung (€/Lfm)", adminPass: "Admin Passwort"
        };

        // PRIO: Wir schauen erst, ob LocalStorage DA ist. Falls ja, nutzen wir es.
        // Wenn du den Reset-Button drückst, löschen wir LocalStorage und erzwingen DEFAULTS.
        let stones = JSON.parse(localStorage.getItem('ls_stones')) || DEFAULTS.stones;
        let config = JSON.parse(localStorage.getItem('ls_config')) || DEFAULTS.config;
        let activeServices = { measure: false, delivery: false };
        let currentUser = null;

        const updateStatus = (text, colorClass, debugMsg = "") => {
            const elText = document.getElementById('status-text');
            const elIcon = document.getElementById('status-icon');
            const elErr = document.getElementById('error-display');
            if (elText) elText.innerText = text;
            if (elIcon) elIcon.className = `w-2 h-2 rounded-full ${colorClass}`;
            if (debugMsg && elErr) {
                elErr.innerText = debugMsg;
                elErr.classList.remove('hidden');
            }
        };

        const showAlert = (msg) => {
            const box = document.getElementById('alert-box');
            const text = document.getElementById('alert-text');
            if (text) text.innerText = msg;
            if (box) box.classList.remove('hidden');
            setTimeout(() => box && box.classList.add('hidden'), 4000);
        };

        const initSync = async () => {
            if (!firebaseConfig.apiKey) {
                updateStatus("Keys fehlen", "bg-red-500", "API-Keys im Code eintragen.");
                render();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        updateStatus("Verbinde...", "bg-blue-500 animate-pulse");
                        
                        // PFAD: artifacts/{appId}/public/data/settings/doc
                        const docRef = doc(db, 'artifacts', internalAppId, 'public', 'data', 'settings', 'doc');
                        
                        onSnapshot(docRef, (snap) => {
                            if (isUploading) return;

                            if (snap.exists()) {
                                const data = snap.data();
                                // Nur übernehmen, wenn Cloud-Daten NEUER sind als unsere letzte lokale Aktion
                                if (!data.updated || data.updated > lastLocalUpdate) {
                                    stones = data.stones || stones;
                                    config = data.config || config;
                                    localStorage.setItem('ls_stones', JSON.stringify(stones));
                                    localStorage.setItem('ls_config', JSON.stringify(config));
                                    updateStatus("Cloud Aktiv", "bg-green-500");
                                    document.getElementById('error-display').classList.add('hidden');
                                    document.getElementById('manual-init-btn').classList.add('hidden');
                                    render();
                                }
                            } else {
                                updateStatus("Cloud Leer", "bg-amber-500", "Keine Cloud-Daten. Button unten nutzen.");
                                document.getElementById('manual-init-btn').classList.remove('hidden');
                                render();
                            }
                        }, (err) => {
                            updateStatus("Fehler", "bg-red-500", "Snapshot Error: " + err.message);
                            render();
                        });
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                updateStatus("Abbruch", "bg-red-600", e.message);
                render();
            }
        };

        window.pushToCloud = async () => {
            if (!db || !currentUser) {
                showAlert("Keine DB-Verbindung!");
                return;
            }
            isUploading = true;
            updateStatus("Sende...", "bg-blue-500 animate-pulse");
            const ts = Date.now();
            
            try {
                const docRef = doc(db, 'artifacts', internalAppId, 'public', 'data', 'settings', 'doc');
                await setDoc(docRef, { 
                    stones, config, updated: ts, editor: currentUser.uid 
                });
                lastLocalUpdate = ts;
                localStorage.setItem('ls_stones', JSON.stringify(stones));
                localStorage.setItem('ls_config', JSON.stringify(config));
                showAlert("Cloud erfolgreich aktualisiert!");
                updateStatus("Cloud Aktiv", "bg-green-500");
                document.getElementById('manual-init-btn').classList.add('hidden');
            } catch (e) {
                showAlert("Upload fehlgeschlagen!");
                updateStatus("Fehler", "bg-red-500", "Upload Error: " + e.message);
            } finally {
                isUploading = false;
            }
        };

        // Hilfsfunktion: Löscht lokalen Cache und schiebt DEFAULTS hoch
        window.resetAndPush = () => {
            localStorage.removeItem('ls_stones');
            localStorage.removeItem('ls_config');
            stones = JSON.parse(JSON.stringify(DEFAULTS.stones));
            config = JSON.parse(JSON.stringify(DEFAULTS.config));
            lastLocalUpdate = Date.now();
            window.pushToCloud();
        };

        window.markLocalUpdate = () => {
            lastLocalUpdate = Date.now();
            localStorage.setItem('ls_stones', JSON.stringify(stones));
            localStorage.setItem('ls_config', JSON.stringify(config));
        };

        window.calculate = () => {
            const sel = document.getElementById('stoneSelect');
            if (!sel) return;
            const stone = stones[sel.selectedIndex];
            if (!stone) return;

            const edgeRate = stone.isDekton ? config.dekEdge : config.natEdge;
            const cutRate = stone.isDekton ? config.dekCut : config.natCut;
            
            document.getElementById('materialBadge').innerHTML = stone.isDekton ? '<span class="badge-dekton">DEKTON</span>' : '<span class="badge-natur">NATURSTEIN</span>';
            
            const sqm = parseFloat(document.getElementById('sqmInput').value) || 0;
            const lfm = parseFloat(document.getElementById('lfmInput').value) || 0;
            const miter = parseFloat(document.getElementById('miterInput').value) || 0;
            const flush = parseInt(document.getElementById('flushCount').innerText);
            const under = parseInt(document.getElementById('underCount').innerText);
            const glue = document.getElementById('gluingCheck').checked;

            const sumMat = sqm * stone.price;
            const sumEdge = lfm * edgeRate;
            const sumCut = (flush + under) * cutRate;
            const sumExtra = (miter * (config.miter || 0)) + (glue ? config.gluing : 0) + (activeServices.measure ? config.measure : 0) + (activeServices.delivery ? config.delivery : 0);

            const ek = sumMat + sumEdge + sumCut + sumExtra;
            const fmt = v => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(v);

            document.getElementById('resMat').innerText = fmt(sumMat);
            document.getElementById('resEdge').innerText = fmt(sumEdge);
            document.getElementById('resCut').innerText = fmt(sumCut);
            document.getElementById('resExtra').innerText = fmt(sumExtra);
            document.getElementById('totalEK').innerText = fmt(ek);
            document.getElementById('totalVK').innerText = fmt(ek * config.factor);
        };

        window.toggleService = (service) => {
            activeServices[service] = !activeServices[service];
            const btn = document.getElementById(`btn-${service}`);
            btn.className = activeServices[service] 
                ? 'py-3 px-2 border border-blue-500 rounded-xl text-[10px] font-bold text-blue-500 uppercase bg-blue-500/10 shadow-inner'
                : 'py-3 px-2 border border-darkBorder rounded-xl text-[10px] font-bold text-slate-500 uppercase transition-all';
            window.calculate();
        };

        window.toggleGlue = () => {
            const cb = document.getElementById('gluingCheck');
            const lbl = document.getElementById('gluingLabel');
            lbl.className = cb.checked 
                ? 'flex items-center justify-center p-4 border-2 border-blue-500 rounded-xl cursor-pointer bg-blue-500/10 text-blue-500 h-[54px] shadow-inner'
                : 'flex items-center justify-center p-4 border-2 border-dashed rounded-xl cursor-pointer hover:bg-slate-100 dark:hover:bg-white/5 border-slate-200 dark:border-darkBorder h-[54px]';
            window.calculate();
        };

        window.updateCounter = (id, d) => {
            const el = document.getElementById(id);
            el.innerText = Math.max(0, parseInt(el.innerText) + d);
            window.calculate();
        };

        window.resetCalculator = () => {
            document.getElementById('sqmInput').value = '';
            document.getElementById('lfmInput').value = '';
            document.getElementById('miterInput').value = '';
            document.getElementById('flushCount').innerText = '0';
            document.getElementById('underCount').innerText = '0';
            document.getElementById('gluingCheck').checked = false;
            activeServices.measure = false;
            activeServices.delivery = false;
            toggleGlue();
            window.calculate();
        };

        window.switchTab = (t) => {
            if (t === 'admin' && typeof window.adminAuth === 'undefined') {
                document.getElementById('admin-gate').classList.remove('hidden');
                return;
            }
            document.getElementById('tab-calc').classList.toggle('hidden', t !== 'calc');
            document.getElementById('tab-admin').classList.toggle('hidden', t !== 'admin');
            document.getElementById('btn-calc').className = t === 'calc' ? 'tab-btn active-tab uppercase tracking-widest text-[10px]' : 'tab-btn inactive-tab uppercase tracking-widest text-[10px]';
            document.getElementById('btn-admin').className = t === 'admin' ? 'tab-btn active-tab uppercase tracking-widest text-[10px]' : 'tab-btn inactive-tab uppercase tracking-widest text-[10px]';
            render();
        };

        window.checkAdminPass = () => {
            if (document.getElementById('adminPassInput').value === config.adminPass) {
                window.adminAuth = true;
                document.getElementById('admin-gate').classList.add('hidden');
                switchTab('admin');
            } else { showAlert("Passwort falsch!"); }
        };

        window.closeAdminGate = () => document.getElementById('admin-gate').classList.add('hidden');

        window.addStone = () => {
            stones.push({ name: "Neuer Stein...", price: 0, isDekton: false });
            markLocalUpdate();
            render();
        };

        const render = () => {
            const sel = document.getElementById('stoneSelect');
            if (!sel) return;
            const curIdx = sel.selectedIndex >= 0 ? sel.selectedIndex : 0;
            sel.innerHTML = stones.map((s, i) => `<option value="${i}">${s.name}</option>`).join('');
            if (curIdx < stones.length) sel.selectedIndex = curIdx;

            const fieldsContainer = document.getElementById('admin-fields');
            if (fieldsContainer) {
                fieldsContainer.innerHTML = Object.keys(config).map(k => `
                    <div>
                        <label class="text-[9px] font-black text-slate-500 uppercase block mb-1">${configLabels[k] || k}</label>
                        <input type="${k === 'adminPass' ? 'text' : 'number'}" step="0.01" value="${config[k]}" 
                            oninput="config['${k}']=this.type==='number'?parseFloat(this.value):this.value; markLocalUpdate();" 
                            class="input-field text-sm font-mono">
                    </div>
                `).join('');
            }

            const tableContainer = document.getElementById('admin-table');
            if (tableContainer) {
                tableContainer.innerHTML = stones.map((s, i) => `
                    <div class="flex flex-col gap-2 p-3 bg-slate-50 dark:bg-black rounded-xl border dark:border-darkBorder group transition-all">
                        <input value="${s.name}" oninput="stones[${i}].name=this.value; markLocalUpdate();" placeholder="Stein Name" class="bg-transparent font-bold outline-none text-sm px-1 py-1 border-b border-transparent focus:border-blue-500">
                        <div class="flex items-center gap-2">
                            <label class="text-[8px] font-black text-slate-500 uppercase mr-1">EK €/m²</label>
                            <input type="number" value="${s.price}" oninput="stones[${i}].price=parseFloat(this.value); markLocalUpdate(); calculate();" class="bg-white dark:bg-darkCard w-20 text-center font-mono border dark:border-darkBorder rounded-lg p-1 text-xs">
                            <button onclick="stones[${i}].isDekton=!stones[${i}].isDekton; markLocalUpdate(); render();" class="text-[8px] font-black px-3 py-2 rounded-lg ${s.isDekton?'bg-red-500 text-white':'bg-emerald-500 text-white'} uppercase transition-all w-24">
                                ${s.isDekton?'Dekton':'Naturstein'}
                            </button>
                            <button onclick="stones.splice(${i},1); markLocalUpdate(); render();" class="text-red-500 px-3 font-bold">✕</button>
                        </div>
                    </div>
                `).join('');
            }
            window.calculate();
        };

        window.toggleTheme = () => {
            const isD = document.documentElement.classList.toggle('dark');
            localStorage.setItem('ls_theme', isD ? 'dark' : 'light');
            document.getElementById('sunIcon').classList.toggle('hidden', !isD);
            document.getElementById('moonIcon').classList.toggle('hidden', isD);
        };
        
        const t = localStorage.getItem('ls_theme');
        if (t==='dark'||(!t&&window.matchMedia('(prefers-color-scheme:dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('sunIcon').classList.remove('hidden');
            document.getElementById('moonIcon').classList.add('hidden');
        }

        initSync();
    </script>
</body>
</html>
