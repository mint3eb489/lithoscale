<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SteinKalk Pro Cloud</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { trueBlack: '#000000', darkCard: '#121212', darkBorder: '#262626' } } } }
    </script>
    <style>
        body { transition: background-color 0.2s; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; }
        .input-field { border: 1.5px solid #e2e8f0; border-radius: 0.75rem; padding: 0.8rem; width: 100%; outline: none; font-size: 16px; font-weight: 600; }
        .dark .card { background-color: #121212; border-color: #262626; }
        .dark .input-field { background-color: #1a1a1a; border-color: #333; color: white; }
        .badge-dekton { background: #ef4444; color: white; padding: 3px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 900; }
        .badge-natur { background: #10b981; color: white; padding: 3px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 900; }
        .tab-btn { padding: 0.8rem; font-weight: 700; border-radius: 0.8rem; flex: 1; text-align: center; transition: 0.2s; }
        .active-tab { background: #1a1a1a; color: white; }
        .dark .active-tab { background: white; color: black; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-3 md:p-8 bg-slate-50 dark:bg-trueBlack text-slate-900 dark:text-slate-100">
    <div id="app" class="max-w-4xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 no-print gap-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-black dark:bg-white rounded-xl flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-blue-500 dark:text-black" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 3h18v18H3zM3 9h18M9 3v18" stroke-linecap="round"/></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black">SteinKalk <span class="text-blue-600">Pro</span></h1>
                    <p id="status" class="text-slate-400 text-[9px] font-bold uppercase tracking-widest italic">Verbinde Cloud...</p>
                </div>
            </div>
            <div class="flex bg-white dark:bg-darkCard p-1 rounded-2xl border dark:border-darkBorder shadow-sm w-full md:w-auto">
                <button onclick="switchTab('calc')" id="btn-calc" class="tab-btn active-tab uppercase tracking-widest">Rechner</button>
                <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn text-slate-500 uppercase tracking-widest">Admin</button>
            </div>
        </header>

        <div id="tab-calc" class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 space-y-5">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Konfiguration</h2>
                        <div id="materialBadge"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Material</label>
                            <select id="stoneSelect" class="input-field mt-1" onchange="calculate()"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Fläche (m²)</label>
                            <input type="number" id="sqmInput" placeholder="0,00" step="0.01" class="input-field mt-1 font-mono" oninput="calculate()">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Kante (Lfm)</label>
                            <input type="number" id="lfmInput" placeholder="0,00" step="0.01" class="input-field mt-1 font-mono" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Bearbeitung</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-black rounded-xl border dark:border-darkBorder">
                            <span class="text-sm font-bold">Flächenbündig</span>
                            <div class="flex items-center gap-3">
                                <button onclick="updateCounter('flushCount', -1)" class="w-8 h-8 bg-white dark:bg-darkCard rounded border dark:border-darkBorder">-</button>
                                <span id="flushCount" class="font-bold w-4 text-center">0</span>
                                <button onclick="updateCounter('flushCount', 1)" class="w-8 h-8 bg-white dark:bg-darkCard rounded border dark:border-darkBorder">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-black rounded-xl border dark:border-darkBorder">
                            <span class="text-sm font-bold">Unterbau</span>
                            <div class="flex items-center gap-3">
                                <button onclick="updateCounter('underCount', -1)" class="w-8 h-8 bg-white dark:bg-darkCard rounded border dark:border-darkBorder">-</button>
                                <span id="underCount" class="font-bold w-4 text-center">0</span>
                                <button onclick="updateCounter('underCount', 1)" class="w-8 h-8 bg-white dark:bg-darkCard rounded border dark:border-darkBorder">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="card p-8 bg-black text-white rounded-3xl shadow-2xl border border-darkBorder">
                    <div class="space-y-4 mb-8 text-xs border-b border-darkBorder pb-6">
                        <div class="flex justify-between text-slate-500 font-bold"><span>MATERIAL</span><span id="resMat" class="text-slate-200">0,00 €</span></div>
                        <div class="flex justify-between text-slate-500 font-bold"><span>KANTEN</span><span id="resEdge" class="text-slate-200">0,00 €</span></div>
                        <div class="flex justify-between text-slate-500 font-bold"><span>AUSSCHNITTE</span><span id="resCut" class="text-slate-200">0,00 €</span></div>
                    </div>
                    <div class="text-center mb-8">
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2">Verkaufspreis (VK)</p>
                        <p id="totalVK" class="font-black text-blue-500 text-5xl tracking-tighter">0,00 €</p>
                        <p class="text-[9px] text-slate-600 mt-2 italic font-bold uppercase">Inkl. MwSt. & Faktor</p>
                    </div>
                    <button onclick="window.print()" class="w-full bg-white text-black font-black py-4 rounded-xl uppercase text-xs tracking-widest active:scale-95 transition-all">Angebot drucken</button>
                </div>
            </div>
        </div>

        <div id="tab-admin" class="hidden space-y-6 no-print">
            <div class="card p-6">
                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Einstellungen</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-bold uppercase text-slate-500">VK-Faktor</label>
                        <input type="number" id="cfgFactor" step="0.1" class="input-field mt-1" onchange="saveConfig()">
                    </div>
                </div>
            </div>
            <div class="card p-6">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Materialdatenbank</h2>
                    <button onclick="addStone()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold">+ NEU</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead><tr class="text-slate-400 uppercase font-black border-b border-slate-100 dark:border-darkBorder"><th class="pb-2">Name</th><th class="pb-2">EK/m²</th><th class="pb-2">Typ</th><th class="pb-2 text-right">X</th></tr></thead>
                        <tbody id="adminStones" class="divide-y divide-slate-50 dark:divide-darkBorder"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
    apiKey: "AIzaSyCAoHre4UD7u88JyGvyPYzrfm50OsMOrZ8",
    authDomain: "lithoscalepro.firebaseapp.com",
    projectId: "lithoscalepro",
    storageBucket: "lithoscalepro.firebasestorage.app",
    messagingSenderId: "1090400345045",
    appId: "1:1090400345045:web:fd1cc58fd1e620a9127b5c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "stein-kalk-cloud-prod";

        let config = { factor: 1.5, natEdge: 15, dekEdge: 20, natCut: 137, dekCut: 177 };
        let stones = [];

        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, u => {
                    if (u) {
                        document.getElementById('status').innerText = "Cloud Online";
                        document.getElementById('status').classList.remove('text-slate-400');
                        document.getElementById('status').classList.add('text-green-500');
                        sync();
                    }
                });
            } catch(e) { document.getElementById('status').innerText = "Offline Modus"; }
        }

        function sync() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config'), snap => {
                if (snap.exists()) { config = snap.data(); calculate(); renderAdmin(); }
                else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config'), config);
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stones'), snap => {
                stones = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
                renderSelect();
                renderAdmin();
                calculate();
            });
        }

        const fmt = v => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(v);

        window.calculate = () => {
            const stone = stones[document.getElementById('stoneSelect').value];
            if (!stone) return;
            const sqm = parseFloat(document.getElementById('sqmInput').value) || 0;
            const lfm = parseFloat(document.getElementById('lfmInput').value) || 0;
            const flush = parseInt(document.getElementById('flushCount').innerText);
            const under = parseInt(document.getElementById('underCount').innerText);

            const edgeRate = stone.isDekton ? config.dekEdge : config.natEdge;
            const cutRate = stone.isDekton ? config.dekCut : config.natCut;

            const matEK = sqm * stone.price;
            const edgeEK = lfm * edgeRate;
            const cutEK = (flush + under) * cutRate;
            const totalVK = (matEK + edgeEK + cutEK) * config.factor;

            document.getElementById('materialBadge').innerHTML = stone.isDekton ? '<span class="badge-dekton">DEKTON</span>' : '<span class="badge-natur">NATURSTEIN</span>';
            document.getElementById('resMat').innerText = fmt(matEK);
            document.getElementById('resEdge').innerText = fmt(edgeEK);
            document.getElementById('resCut').innerText = fmt(cutEK);
            document.getElementById('totalVK').innerText = fmt(totalVK);
        };

        window.updateCounter = (id, d) => {
            const el = document.getElementById(id);
            el.innerText = Math.max(0, parseInt(el.innerText) + d);
            calculate();
        };

        window.switchTab = tab => {
            document.getElementById('tab-calc').classList.toggle('hidden', tab !== 'calc');
            document.getElementById('tab-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('btn-calc').className = tab === 'calc' ? 'tab-btn active-tab uppercase tracking-widest' : 'tab-btn inactive-tab uppercase tracking-widest';
            document.getElementById('btn-admin').className = tab === 'admin' ? 'tab-btn active-tab uppercase tracking-widest' : 'tab-btn inactive-tab uppercase tracking-widest';
        };

        function renderSelect() {
            const sel = document.getElementById('stoneSelect');
            const cur = sel.value;
            sel.innerHTML = stones.map((s, i) => `<option value="${i}">${s.name} (${s.price} €/m²)</option>`).join('');
            if (cur < stones.length) sel.value = cur;
        }

        function renderAdmin() {
            document.getElementById('cfgFactor').value = config.factor;
            const body = document.getElementById('adminStones');
            body.innerHTML = stones.map((s, i) => `
                <tr>
                    <td class="py-2"><input type="text" value="${s.name}" class="bg-transparent font-bold w-full" onchange="window.updStone('${s.id}','name',this.value)"></td>
                    <td><input type="number" value="${s.price}" class="bg-transparent font-mono w-16" onchange="window.updStone('${s.id}','price',parseFloat(this.value))"></td>
                    <td><select onchange="window.updStone('${s.id}','isDekton',this.value==='t')"><option value="f" ${!s.isDekton?'selected':''}>Natur</option><option value="t" ${s.isDekton?'selected':''}>Dekton</option></select></td>
                    <td class="text-right"><button onclick="window.delStone('${s.id}')" class="text-red-500 font-bold">X</button></td>
                </tr>
            `).join('');
        }

        window.saveConfig = () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config'), { factor: parseFloat(document.getElementById('cfgFactor').value) });
        window.updStone = (id, f, v) => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stones', id), { [f]: v });
        window.delStone = id => confirm("Löschen?") && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stones', id));
        window.addStone = () => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stones'), { name: "Neuer Stein", price: 0, isDekton: false });

        init();
    </script>
</body>
</html>
